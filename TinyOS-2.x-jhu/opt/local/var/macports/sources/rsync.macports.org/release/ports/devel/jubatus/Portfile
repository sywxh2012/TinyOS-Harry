# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 89206 2012-01-21 07:20:02Z hum@macports.org $

PortSystem          1.0
PortGroup           github 1.0

github.setup        jubatus jubatus 0.1.1 jubatus-
revision            1
categories          devel math textproc
platforms           darwin
maintainers         hum openmaintainer
license             LGPL-2.1

homepage            http://jubat.us/
description         Distributed Online Machine Learning Framework
long_description    The Jubatus library is a online machine learning framework \
                    which runs in distributed environment. Jubatus library includes \
                    these functions: multi-class/binary classification, pre-proccessing \
                    data (for natural language), and process management.

fetch.type          git
git.branch          3646d09fa6

depends_lib         port:pkgconfig \
                    port:py-msgpack \
                    port:msgpack \
                    port:pficommon \
                    port:re2 \
                    port:google-glog \
                    port:ux-trie \
                    port:mecab-utf8 \
                    port:libzookeeper

patchfiles          patch-wscript.diff \
                    patch-zk.hpp.diff

post-patch {
    reinplace "s|/usr/local|${prefix}|g" ${worksrcpath}/wscript
}

configure.cmd       ./waf configure
configure.args-append    --enable-ux --enable-mecab
configure.universal_args

if {${configure.compiler} == "clang"} {
    configure.compiler llvm-gcc-4.2
}

build.cmd           ./waf build
build.target

destroot.cmd        ./waf
destroot.args       --destdir=${destroot}
destroot.destdir

post-destroot {
    set libdir   ${destroot}${prefix}/lib
    foreach libname [glob -tails -directory ${libdir} *.dylib] {
        system "install_name_tool -id ${prefix}/lib/${libname} ${libdir}/${libname}"
    }
    set bindir   ${destroot}${prefix}/bin
    set builddir ${worksrcpath}/build/src
    foreach path [concat [glob ${libdir}/*.dylib] [glob ${bindir}/*]] {
        system "install_name_tool -change ${builddir}/client/libjubatus.dylib                         ${prefix}/lib/libjubatus.dylib            ${path}"
        system "install_name_tool -change ${builddir}/common/libjubacommon.dylib                      ${prefix}/lib/libjubacommon.dylib         ${path}"
        system "install_name_tool -change ${builddir}/plugin/fv_converter/libmecab_splitter.dylib     ${prefix}/lib/libmecab_splitter.dylib     ${path}"
        system "install_name_tool -change ${builddir}/plugin/fv_converter/libux_splitter.dylib        ${prefix}/lib/libux_splitter.dylib        ${path}"
        system "install_name_tool -change ${builddir}/server/classifier/libjubaclassifier.dylib       ${prefix}/lib/libjubaclassifier.dylib     ${path}"
        system "install_name_tool -change ${builddir}/server/fv_converter/libfilter_sample.dylib      ${prefix}/lib/libfilter_sample.dylib      ${path}"
        system "install_name_tool -change ${builddir}/server/fv_converter/libjubaconverter.dylib      ${prefix}/lib/libjubaconverter.dylib      ${path}"
        system "install_name_tool -change ${builddir}/server/fv_converter/libnum_feature_sample.dylib ${prefix}/lib/libnum_feature_sample.dylib ${path}"
        system "install_name_tool -change ${builddir}/server/fv_converter/libnum_filter_sample.dylib  ${prefix}/lib/libnum_filter_sample.dylib  ${path}"
        system "install_name_tool -change ${builddir}/server/fv_converter/libsplitter_sample.dylib    ${prefix}/lib/libsplitter_sample.dylib    ${path}"
        system "install_name_tool -change ${builddir}/server/storage/libjubastorage.dylib             ${prefix}/lib/libjubastorage.dylib        ${path}"
    }
}
